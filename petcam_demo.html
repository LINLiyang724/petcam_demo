<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetGuard å®Œæ•´æ¼”ç¤ºç‰ˆ (Final)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0"
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* éšè—æ»šåŠ¨æ¡ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.5); opacity: 0; } }
        .animate-pulse-ring { animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Camera, Activity, Bell, Settings, Play, Pause, AlertTriangle, Clock, X, 
            Sparkles, Utensils, Moon, Footprints, Upload, Volume2, VolumeX, Eye, 
            Radio, MessageCircle, Send, User, Bot, Filter, ZoomIn, PlayCircle, Film, 
            Loader2, Wifi, Battery, ChevronRight, Edit2, Shield, Droplets, Calendar, 
            BarChart2, ChevronLeft, Minimize2, ShoppingBag, HeartPulse, Lightbulb, CheckCircle,
            Mail, Lock, Cat, Scale, Ruler, Mic, ShieldCheck, Check, Plus, Trash2, HelpCircle
        } from 'lucide-react';

        // ==========================================
        // ğŸŸ¢ æ¨¡å—ä¸€ï¼šOnboarding (åˆå§‹å¼•å¯¼ä¸è®¾ç½®)
        // ==========================================
        
        const Onboarding = ({ onComplete }) => {
            const [step, setStep] = useState(0); 
            // è¿æ¥çŠ¶æ€ï¼šidle, scanning, connecting, success, failed
            const [connectStatus, setConnectStatus] = useState('idle');
            const [failReason, setFailReason] = useState('');
            
            // å·²æ·»åŠ çš„å® ç‰©åˆ—è¡¨
            const [addedPets, setAddedPets] = useState([]);
            // å½“å‰æ­£åœ¨è¾“å…¥çš„è¡¨å•
            const [formData, setFormData] = useState({
                petName: '',
                petBreed: '',
                petWeight: '',
            });

            // --- é€»è¾‘ï¼šæ·»åŠ å® ç‰© ---
            const handleAddAnother = () => {
                if (!formData.petName) return;
                const newPet = { ...formData, id: Date.now() }; 
                setAddedPets([...addedPets, newPet]);
                setFormData({ petName: '', petBreed: '', petWeight: '' }); // é‡ç½®è¡¨å•
            };

            const handleRemovePet = (id) => {
                setAddedPets(addedPets.filter(p => p.id !== id));
            };

            // --- é€»è¾‘ï¼šè¿›å…¥ä¸‹ä¸€æ­¥ ---
            const handleNextFromProfile = () => {
                // å¦‚æœè¾“å…¥æ¡†é‡Œè¿˜æœ‰æœªä¿å­˜çš„æ•°æ®ï¼Œè‡ªåŠ¨ä¿å­˜
                let finalPets = [...addedPets];
                if (formData.petName) {
                    finalPets.push({ ...formData, id: Date.now() });
                }

                if (finalPets.length === 0) {
                    alert("è¯·è‡³å°‘æ·»åŠ ä¸€åªå® ç‰©å“¦~");
                    return;
                }
                setAddedPets(finalPets);
                setStep(4); // å»æƒé™é¡µ
            };

            // --- é€»è¾‘ï¼šé…ç½‘ (å«æ¨¡æ‹Ÿå¤±è´¥) ---
            const handleConnect = () => {
                setConnectStatus('scanning');
                setFailReason('');
                
                setTimeout(() => {
                    setConnectStatus('connecting');
                    
                    // 2.5ç§’åå‡ºç»“æœ
                    setTimeout(() => {
                        // ğŸ² éšæœºç”Ÿæˆç»“æœï¼š50% æˆåŠŸï¼Œ50% å¤±è´¥ (ç”¨äºæ¼”ç¤º)
                        const isSuccess = Math.random() > 0.5;
                        
                        if (isSuccess) {
                            setConnectStatus('success');
                        } else {
                            setConnectStatus('failed');
                            const reasons = ["æœªæ‰«æåˆ°è®¾å¤‡ï¼Œè¯·æ£€æŸ¥è“ç¯", "WiFi å¯†ç éªŒè¯å¤±è´¥", "è¿æ¥è¶…æ—¶ï¼Œè¯·é è¿‘é‡è¯•"];
                            setFailReason(reasons[Math.floor(Math.random() * reasons.length)]);
                        }
                    }, 2000);
                }, 1500); 
            };

            // é‡ç½®é…ç½‘çŠ¶æ€
            const handleRetry = () => {
                setConnectStatus('idle');
                setFailReason('');
            };

            // Step 0: å¼€å±é¡µ
            if (step === 0) return (
                <div className="h-screen bg-orange-500 flex flex-col items-center justify-center text-white relative overflow-hidden cursor-pointer" onClick={() => setStep(1)}>
                    <div className="bg-white p-4 rounded-3xl mb-6 shadow-2xl animate-fade-in">
                        <Cat size={64} className="text-orange-500" />
                    </div>
                    <h1 className="text-4xl font-extrabold tracking-tight mb-2 animate-fade-in">PetGuard</h1>
                    <p className="opacity-90 animate-fade-in">AI é©±åŠ¨çš„æ™ºèƒ½å…»å® ä¸“å®¶</p>
                    <div className="absolute bottom-10 text-sm opacity-60 animate-pulse">ç‚¹å‡»å±å¹•å¼€å§‹ä½“éªŒ</div>
                </div>
            );

            // Step 1: ç™»å½•é¡µ
            if (step === 1) return (
                <div className="h-screen bg-gray-50 max-w-md mx-auto flex flex-col p-6 pt-20 animate-fade-in">
                    <h1 className="text-3xl font-bold text-gray-900 mb-2">æ¬¢è¿å›æ¥ ğŸ‘‹</h1>
                    <p className="text-gray-500 mb-8">ç™»å½•ä»¥è¿æ¥æ‚¨çš„ PetGuard è®¾å¤‡</p>
                    <div className="space-y-4">
                        <div className="relative"><Mail className="absolute left-4 top-3.5 text-gray-400" size={20} /><input type="email" placeholder="é‚®ç®±åœ°å€" className="w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:outline-none focus:border-orange-500 transition-all" /></div>
                        <div className="relative"><Lock className="absolute left-4 top-3.5 text-gray-400" size={20} /><input type="password" placeholder="å¯†ç " className="w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:outline-none focus:border-orange-500 transition-all" /></div>
                    </div>
                    <div className="mt-auto mb-6">
                        <button onClick={() => setStep(2)} className="w-full bg-orange-500 text-white font-bold py-4 rounded-full shadow-lg hover:bg-orange-600 active:scale-95 transition-all">ç™»å½• / æ³¨å†Œ</button>
                    </div>
                </div>
            );

            // Step 2: é…ç½‘é¡µ (å¤æ‚çŠ¶æ€æœº)
            if (step === 2) return (
                <div className="h-screen bg-gray-50 max-w-md mx-auto flex flex-col p-6 pt-10 animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold">æ·»åŠ è®¾å¤‡</h2>
                        <span className="text-xs font-mono text-orange-500 bg-orange-50 px-2 py-1 rounded">Step 1/3</span>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center relative">
                        {/* çŠ¶æ€åŠ¨ç”»åœ†åœˆ */}
                        <div className={`w-64 h-64 rounded-full border-2 flex items-center justify-center relative transition-all duration-500 ${
                            connectStatus === 'success' ? 'border-green-500 bg-green-50' : 
                            connectStatus === 'failed' ? 'border-red-500 bg-red-50' : 'border-orange-100'
                        }`}>
                            {connectStatus === 'scanning' && <div className="absolute inset-0 rounded-full border-4 border-orange-200 animate-pulse-ring"></div>}
                            
                            {connectStatus === 'idle' && <Camera size={64} className="text-gray-300" />}
                            {(connectStatus === 'scanning' || connectStatus === 'connecting') && <Wifi size={64} className="text-orange-500 animate-pulse" />}
                            {connectStatus === 'success' && <Check size={64} className="text-green-500 animate-in zoom-in" />}
                            {connectStatus === 'failed' && <AlertTriangle size={64} className="text-red-500 animate-in zoom-in" />}
                        </div>

                        {/* çŠ¶æ€æ–‡æœ¬ */}
                        <div className="mt-8 text-center space-y-2 px-4">
                            <h3 className={`text-xl font-bold ${connectStatus === 'failed' ? 'text-red-600' : 'text-gray-800'}`}>
                                {connectStatus === 'idle' ? 'å¼€å¯è®¾å¤‡è“ç‰™' : 
                                 connectStatus === 'scanning' ? 'æ­£åœ¨æœç´¢è®¾å¤‡...' :
                                 connectStatus === 'connecting' ? 'æ­£åœ¨åŒæ­¥ WiFi ä¿¡æ¯...' :
                                 connectStatus === 'success' ? 'è¿æ¥æˆåŠŸï¼' : 'è¿æ¥å¤±è´¥'}
                            </h3>
                            <p className="text-sm text-gray-500">
                                {connectStatus === 'idle' && 'è¯·ç¡®ä¿è®¾å¤‡å·²æ¥é€šç”µæºï¼ŒæŒ‡ç¤ºç¯é—ªçƒè“å…‰'}
                                {connectStatus === 'success' && 'è®¾å¤‡ ID: PG-Cam-8821 å·²ä¸Šçº¿'}
                                {connectStatus === 'failed' && failReason}
                            </p>
                        </div>

                        {/* å¤±è´¥æ—¶çš„æ’æŸ¥å»ºè®® */}
                        {connectStatus === 'failed' && (
                            <div className="mt-6 bg-white p-3 rounded-lg border border-red-100 text-xs text-gray-500 w-full animate-slide-up">
                                <div className="font-bold text-gray-700 mb-1">ğŸ’¡ æ’æŸ¥å»ºè®®ï¼š</div>
                                <ul className="list-disc pl-4 space-y-1">
                                    <li>æ£€æŸ¥ WiFi å¯†ç æ˜¯å¦æ­£ç¡®</li>
                                    <li>æš‚ä¸æ”¯æŒ 5G é¢‘æ®µ WiFi</li>
                                    <li>è¯·é•¿æŒ‰è®¾å¤‡ Reset é”® 5 ç§’é‡ç½®</li>
                                </ul>
                            </div>
                        )}
                    </div>

                    {/* åº•éƒ¨åŠ¨æ€æŒ‰é’® */}
                    <div className="mt-auto mb-6 space-y-3">
                        {connectStatus === 'idle' ? (
                            <button onClick={handleConnect} className="w-full bg-gray-900 text-white font-bold py-4 rounded-full shadow-lg hover:bg-gray-800 transition-all">æœç´¢è®¾å¤‡</button>
                        ) : connectStatus === 'success' ? (
                            <button onClick={() => setStep(3)} className="w-full bg-green-500 text-white font-bold py-4 rounded-full shadow-lg hover:bg-green-600 transition-all flex items-center justify-center gap-2">ä¸‹ä¸€æ­¥ <ChevronRight size={20}/></button>
                        ) : connectStatus === 'failed' ? (
                            <div className="space-y-3 animate-slide-up">
                                <button onClick={handleConnect} className="w-full bg-orange-500 text-white font-bold py-4 rounded-full shadow-lg hover:bg-orange-600 transition-all flex items-center justify-center gap-2">
                                    <Wifi size={20}/> é‡è¯•
                                </button>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setStep(1)} className="w-full bg-white border border-gray-200 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-50 transition-all text-sm">
                                        è¿”å›ä¸Šä¸€æ­¥
                                    </button>
                                    <button onClick={() => alert("æ¨¡æ‹Ÿåˆ‡æ¢åˆ°æ‰«ç æ¨¡å¼")} className="w-full bg-white border border-gray-200 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-50 transition-all text-sm">
                                        åˆ‡æ¢é…ç½‘æ¨¡å¼
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <button disabled className="w-full bg-gray-100 text-gray-400 font-bold py-4 rounded-full cursor-not-allowed flex items-center justify-center gap-2"><Loader2 className="animate-spin" size={20}/> è¿æ¥ä¸­...</button>
                        )}
                    </div>
                </div>
            );

            // Step 3: å® ç‰©æ¡£æ¡ˆ (å¤šå® æ”¯æŒç‰ˆ)
            if (step === 3) return (
                <div className="h-screen bg-gray-50 max-w-md mx-auto flex flex-col p-6 pt-10 animate-fade-in overflow-y-auto">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">è°æ˜¯å°ä¸»è§’ï¼Ÿ</h2><span className="text-xs font-mono text-orange-500 bg-orange-50 px-2 py-1 rounded">Step 2/3</span></div>
                    
                    {/* å·²æ·»åŠ åˆ—è¡¨ */}
                    {addedPets.length > 0 && (
                        <div className="flex gap-2 flex-wrap mb-6 animate-fade-in">
                            {addedPets.map(pet => (
                                <div key={pet.id} className="bg-orange-100 text-orange-700 px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 shadow-sm border border-orange-200">
                                    <Cat size={14}/> {pet.petName}
                                    <button onClick={() => handleRemovePet(pet.id)} className="text-orange-400 hover:text-red-500"><X size={14}/></button>
                                </div>
                            ))}
                        </div>
                    )}

                    <div className="space-y-6 flex-1">
                        <div className="flex justify-center"><div className="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center border-2 border-dashed border-gray-300 text-gray-400"><Camera size={24}/></div></div>
                        <div className="space-y-4">
                            <div><label className="text-xs font-bold text-gray-700 ml-1 mb-1 block">åå­—</label><div className="relative"><Cat className="absolute left-4 top-3.5 text-gray-400" size={18} /><input type="text" placeholder="ä¾‹å¦‚ï¼šæ —å­" value={formData.petName} onChange={e => setFormData({...formData, petName: e.target.value})} className="w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:outline-none focus:border-orange-500 transition-all" /></div></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-gray-700 ml-1 mb-1 block">å“ç§</label><div className="relative"><div className="absolute left-4 top-3.5 text-gray-400"><Ruler size={18}/></div><input type="text" placeholder="å¦‚ï¼šç¾çŸ­" value={formData.petBreed} onChange={e => setFormData({...formData, petBreed: e.target.value})} className="w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:outline-none focus:border-orange-500 transition-all" /></div></div>
                                <div><label className="text-xs font-bold text-gray-700 ml-1 mb-1 block">ä½“é‡ (kg)</label><div className="relative"><div className="absolute left-4 top-3.5 text-gray-400"><Scale size={18}/></div><input type="number" placeholder="0.0" value={formData.petWeight} onChange={e => setFormData({...formData, petWeight: e.target.value})} className="w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:outline-none focus:border-orange-500 transition-all" /></div></div>
                            </div>
                        </div>

                        {/* ä¿å­˜å¹¶æ·»åŠ ä¸‹ä¸€åª */}
                        <button onClick={handleAddAnother} disabled={!formData.petName} className={`w-full border-2 border-dashed border-gray-300 text-gray-400 font-bold py-3 rounded-xl hover:border-orange-400 hover:text-orange-500 transition-all flex items-center justify-center gap-2 ${!formData.petName ? 'opacity-50 cursor-not-allowed' : ''}`}>
                            <Plus size={20}/> ä¿å­˜å½“å‰å¹¶æ·»åŠ ä¸‹ä¸€åª
                        </button>
                    </div>

                    <div className="mt-8 mb-6">
                        <button onClick={handleNextFromProfile} disabled={addedPets.length === 0 && !formData.petName} className={`w-full font-bold py-4 rounded-full shadow-lg transition-all flex items-center justify-center gap-2 ${addedPets.length > 0 || formData.petName ? 'bg-orange-500 text-white hover:bg-orange-600' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>
                            {addedPets.length > 0 ? `å®Œæˆè®¾ç½® (${addedPets.length + (formData.petName?1:0)} åªå® ç‰©)` : 'ä¸‹ä¸€æ­¥'} <ChevronRight size={20}/>
                        </button>
                    </div>
                </div>
            );

            // Step 4: æƒé™ç”³è¯·
            if (step === 4) return (
                <div className="h-screen bg-gray-50 max-w-md mx-auto flex flex-col p-6 pt-10 animate-fade-in">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">æœ€åä¸€æ­¥</h2><span className="text-xs font-mono text-orange-500 bg-orange-50 px-2 py-1 rounded">Step 3/3</span></div>
                    <div className="space-y-4">
                        <div className="bg-white p-4 rounded-2xl border border-orange-200 shadow-sm flex items-center gap-4 relative overflow-hidden">
                            <div className="absolute left-0 top-0 bottom-0 w-1 bg-orange-500"></div><div className="bg-orange-100 p-3 rounded-full text-orange-600"><Bell size={24}/></div>
                            <div className="flex-1"><h4 className="font-bold text-gray-900">å¼‚å¸¸é€šçŸ¥</h4><p className="text-xs text-gray-500 mt-1">æ¥æ”¶å‘•åã€æ‰“æ¶è­¦æŠ¥ã€‚</p></div>
                            <div className="relative inline-flex h-6 w-11 items-center rounded-full bg-orange-500"><span className="translate-x-6 inline-block h-4 w-4 transform rounded-full bg-white transition"/></div>
                        </div>
                    </div>
                    <div className="mt-auto mb-6">
                        <button onClick={() => onComplete(addedPets)} className="w-full bg-gray-900 text-white font-bold py-4 rounded-full shadow-lg hover:bg-gray-800 transition-all flex items-center justify-center gap-2">å¼€å¯å®ˆæŠ¤ä¹‹æ—… <Check size={20}/></button>
                    </div>
                </div>
            );
        };

        // ==========================================
        // ğŸ”µ æ¨¡å—äºŒï¼šDashboard (ä¸»ç¨‹åº - å¤šå® é€‚é…ç‰ˆ)
        // ==========================================
        
        const CONFIG = {
            defaultVideo: "./pet_demo.mp4", 
            alertTriggerTime: 14, 
        };

        const Dashboard = ({ userPets }) => {
            // --- æ•°æ®åˆå§‹åŒ–é€»è¾‘ ---
            // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„å‰ä¸¤åªå® ç‰©ï¼Œå¦‚æœä¸è¶³åˆ™ç”¨é»˜è®¤æ•°æ®è¡¥ä½
            const pet1 = userPets[0] || { petName: "æ —å­", petBreed: "ç‹¸èŠ±çŒ«", petWeight: "4.2" };
            const pet2 = userPets[1] || { petName: "å¥¶æ²¹", petBreed: "é‡‘æ¸å±‚é•¿æ¯›", petWeight: "5.5" }; 

            const mainPetName = pet1.petName;
            const secondPetName = pet2.petName;
            
            // æ„å»ºå® ç‰©æ¡£æ¡ˆ
            const [petData, setPetData] = useState({
                [mainPetName]: { 
                    type: pet1.petBreed || 'æœªçŸ¥å“ç§', weight: (pet1.petWeight || '?') + 'kg',
                    activeLevel: 92, eatCount: 2, drinkCount: 2, 
                    avatarColor: 'bg-gray-200 text-gray-700',
                    recentStatus: 'ç²¾åŠ›è¿‡å‰©',
                    report: `**ã€${mainPetName}æ—¥æŠ¥ã€‘**\nä»Šæ—¥æ ‡ç­¾ï¼š**ç²¾åŠ›è¿‡å‰©**ã€‚\n6ç‚¹åŠå°±å¼€å§‹**è·‘é…·**ï¼Œ10ç‚¹åˆç©äº†çŒ«è–„è·çƒã€‚08:15 åƒäº†æ—©é¤ã€‚æˆªæ­¢ç›®å‰æ´»è·ƒåº¦å…¨å®¶ç¬¬ä¸€ã€‚`,
                    insight: `å»ºè®®ç¡å‰å¢åŠ  15 åˆ†é’Ÿé€—çŒ«æ£’äº’åŠ¨ï¼Œæ¶ˆè€—å…¶å¤šä½™ç²¾åŠ›ï¼Œå‡å°‘å¤œé—´è·‘é…·é¢‘ç‡ã€‚`
                },
                [secondPetName]: { 
                    type: pet2.petBreed || 'æœªçŸ¥å“ç§', weight: (pet2.petWeight || '?') + 'kg',
                    activeLevel: 28, eatCount: 1, drinkCount: 1, 
                    avatarColor: 'bg-yellow-100 text-yellow-700',
                    recentStatus: 'è¿åŠ¨ä¸è¶³',
                    report: `**ã€${secondPetName}æ—¥æŠ¥ã€‘**\nä»Šæ—¥æ ‡ç­¾ï¼š**å²æœˆé™å¥½**ã€‚\né™¤äº†æ—©ä¸Šåƒé¥­å’Œ **09:40 å–æ°´**ï¼Œå‡ ä¹éƒ½åœ¨ç¡è§‰æˆ–æš—ä¸­è§‚å¯Ÿã€‚`,
                    insight: `${secondPetName}æœ¬å‘¨å¹³å‡æ´»è·ƒåº¦ä»… 30%ï¼Œå»ºè®®è¡¥å……æ–°ç©å…·ä»¥æ¿€å‘è¿åŠ¨å…´è¶£ï¼Œé¢„é˜²è‚¥èƒ–ã€‚`
                }
            });

            // æ„å»ºæ—¥å¿—æµ (åŠ¨æ€åå­—)
            const [logs, setLogs] = useState([
                { id: 10, time: '10:45', cat: 'åŒçŒ«', type: 'normal', action: 'è¿½é€æ‰“é—¹', detail: 'å®¢å…å‘ç”ŸçŸ­æ—¶è¿½é€ï¼Œæ´»è·ƒåº¦ä¸Šå‡', videoTime: null, thumbColor: 'bg-indigo-100' },
                { id: 9, time: '10:20', cat: mainPetName, type: 'normal', action: 'ç©è€', detail: 'ç‹¬è‡ªç©çŒ«è–„è·çƒï¼ŒæŒç»­ 5 åˆ†é’Ÿ', videoTime: null, thumbColor: 'bg-orange-100' },
                { id: 8, time: '09:40', cat: secondPetName, type: 'normal', action: 'é¥®æ°´', detail: 'é¥®æ°´é‡çº¦ 45mlï¼Œé¥®æ°´æœºå·¥ä½œæ­£å¸¸', videoTime: null, thumbColor: 'bg-blue-50' },
                { id: 7, time: '08:15', cat: 'åŒçŒ«', type: 'normal', action: 'è¿›é£Ÿ', detail: 'è‡ªåŠ¨å–‚é£Ÿå™¨å‡ºç²®ï¼ŒåŒçŒ«åŒæ—¶è¿›é£Ÿæ—©é¤', videoTime: null, thumbColor: 'bg-green-100' }, 
            ]);

            const [chatMessages, setChatMessages] = useState([
                { id: 1, type: 'bot', text: `ä½ å¥½ï¼æˆ‘æ˜¯ PetGuard æ™ºèƒ½åŠ©æ‰‹ã€‚ä»Šæ—¥ç›‘æ§å·²è¿æ¥ã€‚æ•°æ®åˆ†ææ˜¾ç¤ºï¼š${mainPetName}ä»Šå¤©æ´»åŠ›æ»¡æ»¡ï¼Œ${secondPetName}åˆ™æ¯”è¾ƒå®‰é™ã€‚`, time: '11:00' }
            ]);

            // --- çŠ¶æ€å®šä¹‰ ---
            const [activeTab, setActiveTab] = useState('home');
            const [videoUrl, setVideoUrl] = useState(CONFIG.defaultVideo);
            const [playModal, setPlayModal] = useState({ show: false, startTime: 0, src: null }); 
            const [isAiThinking, setIsAiThinking] = useState(false);
            const [selectedCatFilter, setSelectedCatFilter] = useState('all'); 
            const [inputMessage, setInputMessage] = useState('');
            const [pushNotification, setPushNotification] = useState(null);
            const [triggeredAlerts, setTriggeredAlerts] = useState(new Set());
            const [cameraLabel, setCameraLabel] = useState({ text: 'æ­£åœ¨è¿æ¥...', color: 'bg-blue-500' });
            const [isPlaying, setIsPlaying] = useState(false);
            const [isMuted, setIsMuted] = useState(true);
            
            const videoRef = useRef(null);
            const modalVideoRef = useRef(null);
            const chatContainerRef = useRef(null);

            // æ–‡æœ¬æ ¼å¼åŒ–
            const formatText = (text) => {
                if (!text) return null;
                const parts = text.split(/(\*\*.*?\*\*)/g);
                return parts.map((part, index) => {
                    if (part.startsWith('**') && part.endsWith('**')) return <strong key={index} className="font-bold text-indigo-700">{part.slice(2, -2)}</strong>;
                    return part;
                });
            };

            // è§†é¢‘è„šæœ¬
            const VIDEO_SCRIPT = [
                { startTime: 0, endTime: 8, hasMotion: false, cameraStatus: { text: 'ç›‘æ§ä¸­', color: 'bg-green-500' }, boxes: [] },
                { startTime: 8, endTime: 12, hasMotion: true, cameraStatus: { text: 'è¯†åˆ«ä¸­', color: 'bg-blue-500' }, boxes: [] },
                { 
                    startTime: 12, endTime: 16, hasMotion: true, cameraStatus: { text: 'âš ï¸ å¼‚å¸¸', color: 'bg-orange-500' }, 
                    triggerAlert: { 
                        timeTrigger: CONFIG.alertTriggerTime, 
                        cat: 'åŒçŒ«', 
                        type: 'warning', 
                        action: 'æ·±å¤œè·‘é…·', 
                        title: 'æ£€æµ‹åˆ°æ·±å¤œè·‘é…·è¡Œä¸º', 
                        detail: `ç›‘æµ‹åˆ°å®¢å…å‘ç”Ÿæ¿€çƒˆçš„è¿½é€æ¸¸æˆã€‚${mainPetName}ç‡å…ˆå‘èµ·å†²åˆºï¼Œ${secondPetName}ç´§éšå…¶åã€‚`, 
                        videoTime: CONFIG.alertTriggerTime 
                    },
                    boxes: []
                },
                { startTime: 16, endTime: 100, hasMotion: false, cameraStatus: { text: 'ç›‘æ§ä¸­', color: 'bg-green-500' }, boxes: [] }
            ];

            // è‡ªåŠ¨æ’­æ”¾
            useEffect(() => {
                if (videoUrl === CONFIG.defaultVideo && videoRef.current) {
                   const timer = setTimeout(() => {
                      if(videoRef.current) videoRef.current.play().then(() => { setIsPlaying(true); setCameraLabel({ text: 'ğŸ”´', color: 'bg-green-500' }); }).catch(() => setCameraLabel({ text: 'ç‚¹å‡»æ’­æ”¾', color: 'bg-blue-500' }));
                   }, 800);
                   return () => clearTimeout(timer);
                }
            }, []);

            // èŠå¤©è‡ªåŠ¨æ»šåŠ¨
            useEffect(() => {
                if (chatContainerRef.current) chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
            }, [chatMessages, activeTab]);

            // è§†é¢‘äº‹ä»¶ç›‘å¬
            useEffect(() => {
                if (!videoRef.current) return;
                const videoElement = videoRef.current;
                const handleTimeUpdate = () => {
                    const time = videoElement.currentTime;
                    const activeScript = VIDEO_SCRIPT.find(s => time >= s.startTime && time < s.endTime);
                    if (activeScript) {
                        if (activeScript.hasMotion && !playModal.show) setCameraLabel({ text: 'æ£€æµ‹åˆ°åŠ¨æ€', color: 'bg-blue-500' });
                        else if (!playModal.show) setCameraLabel({ text: 'ğŸ”´', color: 'bg-green-500' });

                        if (activeScript.triggerAlert && Math.floor(time) === activeScript.triggerAlert.timeTrigger && !playModal.show) {
                           const alertId = `alert-${Math.floor(time)}`;
                           if (!triggeredAlerts.has(alertId)) {
                               setTriggeredAlerts(prev => new Set(prev).add(alertId));
                               setPushNotification({ title: activeScript.triggerAlert.title, text: activeScript.triggerAlert.detail, videoTime: activeScript.triggerAlert.videoTime });
                               setTimeout(() => setPushNotification(null), 6000); 
                               const newLog = { id: Date.now(), time: '23:09', cat: activeScript.triggerAlert.cat, type: 'warning', action: activeScript.triggerAlert.action, detail: activeScript.triggerAlert.detail, videoTime: activeScript.triggerAlert.videoTime, thumbColor: 'bg-gray-800 text-white' };
                               setLogs(oldLogs => [newLog, ...oldLogs]); 
                               setChatMessages(prev => [...prev, { id: Date.now(), type: 'push', time: '23:09', alertId: alertId, title: activeScript.triggerAlert.title, text: activeScript.triggerAlert.detail, videoTime: activeScript.triggerAlert.videoTime, isHighlightCard: true }]);
                           }
                        }
                    } 
                };
                videoElement.addEventListener('timeupdate', handleTimeUpdate);
                return () => videoElement.removeEventListener('timeupdate', handleTimeUpdate);
            }, [videoUrl, playModal.show, triggeredAlerts, mainPetName, secondPetName]); 

            useEffect(() => {
                if (playModal.show && modalVideoRef.current) {
                  modalVideoRef.current.currentTime = playModal.startTime;
                  modalVideoRef.current.play().catch(e => {});
                }
            }, [playModal.show]);

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                  const url = URL.createObjectURL(file);
                  setVideoUrl(url);
                  setTriggeredAlerts(new Set()); 
                  setTimeout(() => { if(videoRef.current) { videoRef.current.play(); setIsPlaying(true); } }, 500);
                }
            };
            const togglePlay = () => { if (videoRef.current) { if (isPlaying) videoRef.current.pause(); else videoRef.current.play(); setIsPlaying(!isPlaying); } };
            const handleJumpToVideo = (time, src = null) => {
                const targetSrc = src || videoUrl;
                if (time === null || time === undefined) return;
                if (!targetSrc) return alert("è¯·å…ˆåœ¨ç›‘æ§é¡µä¸Šä¼ è§†é¢‘ï¼");
                setPlayModal({ show: true, startTime: time, src: targetSrc });
                setPushNotification(null);
            };

            const handleSendMessage = async (text = inputMessage) => {
                if (!text.trim()) return;
                const newUserMsg = { id: Date.now(), type: 'user', text: text, time: 'åˆšåˆš' };
                setChatMessages(prev => [...prev, newUserMsg]);
                setInputMessage('');
                setIsAiThinking(true);
                setTimeout(() => {
                    let response = "";
                    if (text.includes("æ€»ç»“")) response = `ä»Šæ—¥æ€»ç»“ï¼š\n1. **${mainPetName}**ï¼šç²¾åŠ›æ—ºç››ï¼Œæœ‰ä¸€æ¬¡è·³æ¡Œå­è¿è§„ã€‚\n2. **${secondPetName}**ï¼šå²æœˆé™å¥½ã€‚`;
                    else if (text.includes(mainPetName)) response = `**${mainPetName}**ä»Šå¤©éå¸¸æ´»è·ƒï¼Œæ—©ä¸Šè·‘é…·ï¼Œæ™šä¸Šè¿˜è·³äº†ä¸€æ¬¡æ¡Œå­ã€‚`;
                    else if (text.includes(secondPetName)) response = `**${secondPetName}**ä»Šå¤©å¾ˆè®©äººçœå¿ƒï¼Œä½†æ´»è·ƒåº¦åä½ã€‚`;
                    else response = `æˆ‘æ˜¯ PetGuard æ™ºèƒ½åŠ©æ‰‹ã€‚æ‚¨å¯ä»¥é—®æˆ‘â€œ${mainPetName}ä»Šå¤©å¹²äº†ä»€ä¹ˆï¼Ÿâ€`;
                    setChatMessages(prev => [...prev, { id: Date.now() + 1, type: 'bot', text: response, time: 'åˆšåˆš' }]);
                    setIsAiThinking(false);
                }, 1500);
            };

            const TabButton = ({ id, icon: Icon, label }) => (
                <button onClick={() => setActiveTab(id)} className={`flex flex-col items-center justify-center w-full py-2 transition-colors ${activeTab === id ? 'text-orange-600' : 'text-gray-400'}`}>
                  <Icon size={24} className={`mb-1 ${activeTab === id ? 'scale-110' : ''} transition-transform`} />
                  <span className="text-[10px] font-medium">{label}</span>
                </button>
            );

            return (
                <div className="bg-gray-50 h-screen font-sans text-gray-900 flex flex-col max-w-md mx-auto shadow-2xl overflow-hidden border-x border-gray-200 animate-fade-in">
                    {pushNotification && (
                        <div onClick={() => handleJumpToVideo(pushNotification.videoTime)} className="fixed top-4 left-4 right-4 bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl z-[60] border-l-4 border-orange-500 p-4 animate-slide-up cursor-pointer flex items-start gap-3 ring-1 ring-black/5 max-w-md mx-auto">
                           <div className="bg-orange-100 p-2 rounded-full text-orange-600 flex-shrink-0 mt-0.5"><AlertTriangle size={20} /></div>
                           <div className="flex-1 min-w-0"><div className="flex justify-between items-start"><h4 className="font-bold text-gray-900 text-sm">PetGuard æ™ºèƒ½è­¦æŠ¥</h4><span className="text-[10px] text-gray-400">åˆšåˆš</span></div><p className="font-medium text-gray-800 text-xs mt-1 truncate">{pushNotification.title}</p><p className="text-gray-500 text-[10px] mt-0.5 line-clamp-2">{pushNotification.text}</p></div>
                        </div>
                    )}
                    
                    {playModal.show && (
                        <div className="fixed inset-0 z-50 bg-black/95 flex flex-col justify-center items-center animate-fade-in">
                          <button onClick={() => setPlayModal({ show: false, startTime: 0, src: null })} className="absolute top-4 right-4 text-white p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-50"><X size={24} /></button>
                          <div className="w-full aspect-video bg-black relative"><video ref={modalVideoRef} src={playModal.src || videoUrl} className="w-full h-full object-contain" controls muted={isMuted} /></div>
                          <div className="mt-6 text-white/90 text-sm bg-gray-800/80 px-6 py-2 rounded-full border border-white/10 flex items-center gap-2"><Sparkles size={14} className="text-yellow-400"/> äº‘ç«¯ AI åˆ†æå›æ”¾</div>
                        </div>
                    )}

                    {/* === Tab 1: é¦–é¡µ === */}
                    <div className={`flex flex-col flex-1 h-full overflow-hidden ${activeTab === 'home' ? 'block' : 'hidden'}`}>
                        <div className="relative bg-black w-full aspect-video flex-shrink-0 z-20 shadow-md">
                            {videoUrl ? (
                              <>
                                <video ref={videoRef} src={videoUrl} className="w-full h-full object-contain bg-black" loop muted={isMuted} playsInline onPlay={() => setIsPlaying(true)} onPause={() => setIsPlaying(false)} onError={() => setVideoUrl(null)} />
                                <div className="absolute top-3
