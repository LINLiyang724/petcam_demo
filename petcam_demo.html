<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetGuard æ™ºèƒ½ç›‘æ§ Demo</title>
    
    <!-- å¼•å…¥ Tailwind CSS (æ ·å¼åº“) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- é…ç½® React å’Œ å›¾æ ‡åº“ -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0"
      }
    }
    </script>

    <!-- å¼•å…¥ Babel (è§£æ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* éšè—æ»šåŠ¨æ¡æ ·å¼ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        /* åŸºç¡€åŠ¨ç”» */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Camera, Activity, Bell, Settings, Play, Pause, AlertTriangle, Clock, X, 
            Sparkles, Utensils, Moon, Footprints, Upload, Volume2, VolumeX, Eye, 
            Radio, MessageCircle, Send, User, Bot, Filter, ZoomIn, PlayCircle, Film, 
            Loader2, Wifi, Battery, ChevronRight, Edit2, Shield, Droplets, Calendar, 
            BarChart2, ChevronLeft, Minimize2
        } from 'lucide-react';

        // ==========================================
        // ğŸ”§ é…ç½®åŒºåŸŸ (åœ¨æ­¤ä¿®æ”¹æ–‡æ¡ˆå’Œæ•°æ®)
        // ==========================================

        const CONFIG = {
            apiKey: "", // Gemini API Key (å¯é€‰)
            defaultVideo: "./pet_demo.mp4", // é»˜è®¤è§†é¢‘ (æ·±å¤œè·‘é…·)
            secondaryVideo: "./pet_demo2.mp4", // ç¬¬äºŒä¸ªè§†é¢‘ (å‘•åäº‹ä»¶)
            currentDate: "11/24", // æ¼”ç¤ºçš„å½“å‰æ—¥æœŸ
            alertTriggerTime: 14, // è§†é¢‘æ’­æ”¾åˆ°ç¬¬å‡ ç§’è§¦å‘æŠ¥è­¦
        };

        // ğŸ± çŒ«å’ªæ¡£æ¡ˆä¸æ—¥æŠ¥æ•°æ®
        const PET_DATA = {
            'æ —å­': { 
                type: 'ç‹¸èŠ±çŒ«', weight: '4.2kg',
                activeLevel: 92, eatCount: 2, drinkCount: 2, 
                avatarColor: 'bg-gray-200 text-gray-700',
                // è¿™é‡Œä¿®æ”¹æ —å­çš„æ—¥æŠ¥æ–‡æ¡ˆ
                report: `**ã€æ —å­æ—¥æŠ¥ã€‘**\nä»Šæ—¥æ ‡ç­¾ï¼š**ç²¾åŠ›è¿‡å‰©**ã€‚\n6ç‚¹åŠå°±å¼€å§‹**è·‘é…·**ï¼Œ10ç‚¹åˆç©äº†çŒ«è–„è·çƒã€‚08:15 åƒäº†æ—©é¤ã€‚æˆªæ­¢ç›®å‰æ´»è·ƒåº¦å…¨å®¶ç¬¬ä¸€ã€‚æ³¨æ„ï¼š23:09 æ£€æµ‹åˆ°**å¤œé—´è·‘é…·**ã€‚`
            },
            'å¥¶æ²¹': { 
                type: 'é‡‘æ¸å±‚é•¿æ¯›', weight: '5.5kg',
                activeLevel: 28, eatCount: 1, drinkCount: 1, 
                avatarColor: 'bg-yellow-100 text-yellow-700',
                // è¿™é‡Œä¿®æ”¹å¥¶æ²¹çš„æ—¥æŠ¥æ–‡æ¡ˆ
                report: `**ã€å¥¶æ²¹æ—¥æŠ¥ã€‘**\nä»Šæ—¥æ ‡ç­¾ï¼š**å²æœˆé™å¥½**ã€‚\né™¤äº†æ—©ä¸Šåƒé¥­å’Œ **09:40 å–æ°´**ï¼Œå‡ ä¹éƒ½åœ¨ç¡è§‰æˆ–æš—ä¸­è§‚å¯Ÿã€‚10:45 è¢«æ —å­å¸¦ç€è·‘äº†ä¸¤æ­¥ï¼Œæ€»ä½“éå¸¸è®©äººçœå¿ƒã€‚`
            }
        };

        // ğŸ“… ä»Šæ—¥æ—¥å¿—åˆ—è¡¨ (æ˜¾ç¤ºåœ¨æ—¥æŠ¥é¡µå’Œ AI é€»è¾‘ä¸­)
        const LOGS_DATA = [
            { id: 10, time: '10:45', cat: 'åŒçŒ«', type: 'normal', action: 'è¿½é€æ‰“é—¹', detail: 'å®¢å…å‘ç”ŸçŸ­æ—¶è¿½é€ï¼Œæ´»è·ƒåº¦ä¸Šå‡ï¼Œæœªæ£€æµ‹åˆ°æ”»å‡»è¡Œä¸º', videoTime: null, thumbColor: 'bg-indigo-100' },
            { id: 9, time: '10:20', cat: 'æ —å­', type: 'normal', action: 'ç©è€', detail: 'ç‹¬è‡ªç©çŒ«è–„è·çƒï¼ŒæŒç»­ 5 åˆ†é’Ÿ', videoTime: null, thumbColor: 'bg-orange-100' },
            { id: 8, time: '09:40', cat: 'å¥¶æ²¹', type: 'normal', action: 'é¥®æ°´', detail: 'é¥®æ°´é‡çº¦ 45mlï¼Œé¥®æ°´æœºå·¥ä½œæ­£å¸¸', videoTime: null, thumbColor: 'bg-blue-50' },
            { id: 7, time: '08:15', cat: 'åŒçŒ«', type: 'normal', action: 'è¿›é£Ÿ', detail: 'è‡ªåŠ¨å–‚é£Ÿå™¨å‡ºç²®ï¼ŒåŒçŒ«åŒæ—¶è¿›é£Ÿæ—©é¤', videoTime: null, thumbColor: 'bg-green-100' }, 
            { id: 6, time: '06:30', cat: 'æ —å­', type: 'normal', action: 'è·‘é…·', detail: 'æ£€æµ‹åˆ°é«˜é¢‘ç§»åŠ¨ï¼Œç–‘ä¼¼æ—©é—´å”¤é†’æœåŠ¡', videoTime: null, thumbColor: 'bg-red-50' },
        ];

        // ğŸ’¬ AI åŠ©æ‰‹åˆå§‹å¯¹è¯
        const INITIAL_CHAT = [
            { id: 1, type: 'bot', text: 'ä½ å¥½ï¼æˆ‘æ˜¯ PetGuard æ™ºèƒ½åŠ©æ‰‹ã€‚ä»Šæ—¥ç›‘æ§å·²è¿æ¥ã€‚æ•°æ®åˆ†ææ˜¾ç¤ºï¼šæ —å­ä»Šå¤©æ´»åŠ›æ»¡æ»¡ï¼Œå¥¶æ²¹åˆ™æ¯”è¾ƒå®‰é™ã€‚', time: '11:00' },
        ];

        // ğŸ“Š å†å²å›¾è¡¨æ•°æ® (æœ€è¿‘7å¤©)
        const WEEKLY_STATS = [
            { date: '11/18', day: 'ä¸€', liziActive: 60, liziEat: 4, creamActive: 20, creamEat: 3 },
            { date: '11/19', day: 'äºŒ', liziActive: 75, liziEat: 5, creamActive: 25, creamEat: 3 },
            { date: '11/20', day: 'ä¸‰', liziActive: 50, liziEat: 3, creamActive: 15, creamEat: 2 },
            { date: '11/21', day: 'å››', liziActive: 80, liziEat: 5, creamActive: 30, creamEat: 4 },
            { date: '11/22', day: 'äº”', liziActive: 65, liziEat: 4, creamActive: 22, creamEat: 3 },
            { date: '11/23', day: 'å…­', liziActive: 90, liziEat: 6, creamActive: 35, creamEat: 4 },
            { date: '11/24', day: 'æ—¥', liziActive: 92, liziEat: 4, creamActive: 28, creamEat: 3 }, 
        ];

        // ğŸ¥ è§†é¢‘è§¦å‘å‰§æœ¬
        // è¿™é‡Œå®šä¹‰åœ¨è§†é¢‘æ’­æ”¾åˆ°ç‰¹å®šæ—¶é—´ç‚¹æ—¶å‘ç”Ÿçš„äº‹æƒ…
        const VIDEO_SCRIPT = [
          // å‰å¥
          { startTime: 0, endTime: 8, hasMotion: false, cameraStatus: { text: 'ç›‘æ§ä¸­', color: 'bg-green-500' } },
          // åŠ¨ä½œå¼€å§‹
          { startTime: 8, endTime: 12, hasMotion: true, cameraStatus: { text: 'è¯†åˆ«ä¸­', color: 'bg-blue-500' } },
          // é«˜æ½®ä¸æŠ¥è­¦
          { 
            startTime: 12, endTime: 16, hasMotion: true, cameraStatus: { text: 'âš ï¸ å¼‚å¸¸', color: 'bg-orange-500' }, 
            // åœ¨è¿™é‡Œé…ç½®è§¦å‘çš„è­¦æŠ¥å†…å®¹
            triggerAlert: { 
              timeTrigger: CONFIG.alertTriggerTime, // 14s
              cat: 'åŒçŒ«', 
              type: 'warning', 
              action: 'æ·±å¤œè·‘é…·', 
              title: 'æ£€æµ‹åˆ°æ·±å¤œè·‘é…·è¡Œä¸º', 
              detail: 'ã€å¤œè§†è¡Œä¸ºåˆ†æã€‘ç›‘æµ‹åˆ°å®¢å…å‘ç”Ÿæ¿€çƒˆçš„è¿½é€æ¸¸æˆã€‚æ —å­ç‡å…ˆå‘èµ·å†²åˆºï¼Œå¥¶æ²¹ç´§éšå…¶åã€‚AI åˆ¤å®šä¸ºé«˜èƒ½ç©è€çŠ¶æ€ã€‚', 
              videoTime: CONFIG.alertTriggerTime 
            }
          },
          // ç»“æŸ
          { startTime: 16, endTime: 100, hasMotion: false, cameraStatus: { text: 'ç›‘æ§ä¸­', color: 'bg-green-500' } }
        ];

        // ==========================================
        // âš™ï¸ é€»è¾‘ä»£ç åŒºåŸŸ (é€šå¸¸æ— éœ€ä¿®æ”¹)
        // ==========================================

        // è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆå†å²æ—¥å†
        const generateCalendarDays = () => {
          const days = [];
          for (let i = 0; i < 6; i++) days.push(null);
          for (let i = 1; i <= 30; i++) days.push(i);
          return days;
        };

        // è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆå†å²å‡æ—¥å¿—
        const getHistoryLogs = (date) => {
          if (date.includes('24')) return LOGS_DATA; 
          
          // å¦‚æœæ˜¯ 23 å·ï¼Œå¼ºåˆ¶è¿”å›åŒ…å«å‘•åè§†é¢‘çš„æ—¥å¿—
          if (date.includes('23')) {
            return [
                { id: '23-1', time: '23:15', cat: 'å¥¶æ²¹', type: 'danger', action: 'å‘•å', detail: 'æ£€æµ‹åˆ°è…¹éƒ¨æŠ½æï¼Œåå‡ºæ¯›çƒï¼Œè¯·å…³æ³¨å¥åº·çŠ¶å†µã€‚', videoTime: 0, thumbColor: 'bg-red-100', videoSrc: CONFIG.secondaryVideo },
                { id: '23-2', time: '14:20', cat: 'åŒçŒ«', type: 'normal', action: 'ç¡è§‰', detail: 'åˆåå°æ†©ï¼Œç¯å¢ƒå®‰é™ã€‚', videoTime: null, thumbColor: 'bg-blue-50' },
                { id: '23-3', time: '08:00', cat: 'æ —å­', type: 'normal', action: 'è¿›é£Ÿ', detail: 'æ­£å¸¸æ—©é¤æ—¶é—´ã€‚', videoTime: null, thumbColor: 'bg-green-50' }
            ];
          }

          // å…¶ä»–æ—¥æœŸéšæœºç”Ÿæˆ
          const events = [
            { cat: 'æ —å­', action: 'æ´»åŠ¨', detail: 'å‡Œæ™¨ä¸‰ç‚¹çš„é«˜é€Ÿè¿åŠ¨', thumbColor: 'bg-orange-100' },
            { cat: 'å¥¶æ²¹', action: 'ä¼‘æ¯', detail: 'åœ¨æ²™å‘ä¸Šç¡äº†æ•´æ•´ä¸€ä¸‹åˆ', thumbColor: 'bg-yellow-50' },
            { cat: 'åŒçŒ«', action: 'è¿›é£Ÿ', detail: 'æ­£å¸¸çš„æ™šé¤æ—¶é—´', thumbColor: 'bg-green-50' },
            { cat: 'æ —å­', action: 'æ´»åŠ¨', detail: 'ç©çŒ«æŠ“æ¿ç£¨çˆªå­', thumbColor: 'bg-gray-100' },
            { cat: 'åŒçŒ«', action: 'ä¼‘æ¯', detail: 'ä¸¤åªçŒ«ç«™åœ¨çª—å°ä¼‘æ¯ï¼Œçœ‹çª—å¤–', thumbColor: 'bg-blue-50' },
          ];
          const count = 3 + Math.floor(Math.random() * 3);
          return Array.from({ length: count }).map((_, i) => {
            const evt = events[Math.floor(Math.random() * events.length)];
            return {
              id: `${date}-${i}`, time: `${10 + i}:30`, cat: evt.cat, type: evt.type || 'normal', action: evt.action, detail: evt.detail, videoTime: evt.videoTime || null, thumbColor: evt.thumbColor
            };
          });
        };

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ– Markdown åŠ ç²—
        const formatText = (text) => {
            if (!text) return null;
            const parts = text.split(/(\*\*.*?\*\*)/g);
            return parts.map((part, index) => {
              if (part.startsWith('**') && part.endsWith('**')) return <strong key={index} className="font-bold text-indigo-700">{part.slice(2, -2)}</strong>;
              return part;
            });
        };

        function App() {
          // --- çŠ¶æ€å®šä¹‰ ---
          const [activeTab, setActiveTab] = useState('home');
          const [logs, setLogs] = useState(LOGS_DATA);
          const [chatMessages, setChatMessages] = useState(INITIAL_CHAT);
          
          const [videoUrl, setVideoUrl] = useState(CONFIG.defaultVideo);
          const [viewMode, setViewMode] = useState('live');
          const [selectedCatFilter, setSelectedCatFilter] = useState('all'); 
          const [recordCatFilter, setRecordCatFilter] = useState('all');
          // playModal å¢åŠ  src å­—æ®µï¼Œæ”¯æŒä¸åŒè§†é¢‘æº
          const [playModal, setPlayModal] = useState({ show: false, startTime: 0, src: null }); 
          const [isAiThinking, setIsAiThinking] = useState(false);
          const [selectedDate, setSelectedDate] = useState(CONFIG.currentDate); 
          const [recordLogs, setRecordLogs] = useState(LOGS_DATA); 
          const [showCalendarModal, setShowCalendarModal] = useState(false); 
          const [motionDetected, setMotionDetected] = useState(false);
          const [cameraLabel, setCameraLabel] = useState({ text: 'æ­£åœ¨è¿æ¥...', color: 'bg-blue-500' });
          const [inputMessage, setInputMessage] = useState('');
          const [pushNotification, setPushNotification] = useState(null);
          const [triggeredAlerts, setTriggeredAlerts] = useState(new Set());

          const videoRef = useRef(null);
          const modalVideoRef = useRef(null);
          const [isPlaying, setIsPlaying] = useState(false);
          const [isMuted, setIsMuted] = useState(true);
          const [currentTime, setCurrentTime] = useState(0);
          const chatContainerRef = useRef(null);

          // --- æ•ˆæœ Hookï¼šè‡ªåŠ¨æ’­æ”¾ ---
          useEffect(() => {
            if (videoUrl === CONFIG.defaultVideo && videoRef.current) {
               const timer = setTimeout(() => {
                  if(videoRef.current) {
                      videoRef.current.play()
                        .then(() => { setIsPlaying(true); setCameraLabel({ text: 'ğŸ”´', color: 'bg-green-500' }); })
                        .catch(e => { console.log("è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢", e); setCameraLabel({ text: 'ç‚¹å‡»æ’­æ”¾', color: 'bg-blue-500' }); });
                  }
               }, 800);
               return () => clearTimeout(timer);
            }
          }, []);

          // --- æ•ˆæœ Hookï¼šå†å²è®°å½•åˆ·æ–° ---
          useEffect(() => {
            setRecordLogs(getHistoryLogs(selectedDate));
          }, [selectedDate]);

          // --- æ•ˆæœ Hookï¼šèŠå¤©è‡ªåŠ¨æ»šåŠ¨ ---
          useEffect(() => {
            if (chatContainerRef.current) {
              chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
            }
          }, [chatMessages, activeTab]);

          // --- è§†é¢‘å¤„ç†é€»è¾‘ ---
          useEffect(() => {
            if (!videoRef.current) return;
            const videoElement = videoRef.current;

            const handleTimeUpdate = () => {
              const time = videoElement.currentTime;
              setCurrentTime(time);
              
              const activeScript = VIDEO_SCRIPT.find(s => time >= s.startTime && time < s.endTime);

              if (activeScript) {
                setMotionDetected(activeScript.hasMotion || false);
                if (activeScript.hasMotion && !playModal.show) {
                    setCameraLabel({ text: 'æ£€æµ‹åˆ°åŠ¨æ€', color: 'bg-blue-500' });
                } else if (!playModal.show) {
                    setCameraLabel({ text: 'ğŸ”´', color: 'bg-green-500' });
                }

                // è§¦å‘æŠ¥è­¦é€»è¾‘
                if (activeScript.triggerAlert && Math.floor(time) === activeScript.triggerAlert.timeTrigger && !playModal.show) {
                   const alertId = `alert-${Math.floor(time)}`;
                   
                   if (!triggeredAlerts.has(alertId)) {
                       setTriggeredAlerts(prev => new Set(prev).add(alertId));
                       
                       // 1. æ˜¾ç¤ºé¡¶éƒ¨ Push
                       setPushNotification({
                         title: activeScript.triggerAlert.title,
                         text: activeScript.triggerAlert.detail,
                         videoTime: activeScript.triggerAlert.videoTime
                       });
                       setTimeout(() => setPushNotification(null), 6000); 
                       
                       // 2. å†™å…¥æ—¥å¿—
                       const newLog = {
                         id: Date.now(), time: '23:09', cat: activeScript.triggerAlert.cat, type: 'warning',
                         action: activeScript.triggerAlert.action, detail: activeScript.triggerAlert.detail,
                         videoTime: activeScript.triggerAlert.videoTime, thumbColor: 'bg-gray-800 text-white' 
                       };
                       setLogs(oldLogs => [newLog, ...oldLogs]); 

                       // 3. å‘é€ AI æ™ºèƒ½å¡ç‰‡
                       setChatMessages(prev => [...prev, {
                         id: Date.now(), type: 'push', time: '23:09', alertId: alertId,
                         title: activeScript.triggerAlert.title, text: activeScript.triggerAlert.detail,
                         videoTime: activeScript.triggerAlert.videoTime,
                         isHighlightCard: true
                       }]);
                   }
                }
              } 
            };

            videoElement.addEventListener('timeupdate', handleTimeUpdate);
            return () => videoElement.removeEventListener('timeupdate', handleTimeUpdate);
          }, [videoUrl, playModal.show, triggeredAlerts]); 

          // --- å¼¹çª—æ’­æ”¾åŒæ­¥ ---
          useEffect(() => {
            if (playModal.show && modalVideoRef.current) {
              modalVideoRef.current.currentTime = playModal.startTime;
              modalVideoRef.current.play().catch(e => {});
            }
          }, [playModal.show]);

          // --- äº‹ä»¶å¤„ç†å‡½æ•° ---
          const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (file) {
              const url = URL.createObjectURL(file);
              setVideoUrl(url);
              setViewMode('live');
              setTriggeredAlerts(new Set()); 
              setTimeout(() => { if(videoRef.current) { videoRef.current.play(); setIsPlaying(true); } }, 500);
            }
          };

          const handleVideoError = () => {
             console.log("é»˜è®¤è§†é¢‘åŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æ‰‹åŠ¨ä¸Šä¼ æ¨¡å¼");
             setVideoUrl(null);
             setCameraLabel({ text: 'ç­‰å¾…è§†é¢‘æº', color: 'bg-gray-400' });
          };

          const togglePlay = () => {
            if (videoRef.current) {
              if (isPlaying) videoRef.current.pause(); else videoRef.current.play();
              setIsPlaying(!isPlaying);
            }
          };

          // æ”¯æŒä¼ å…¥ç‰¹å®šè§†é¢‘æº
          const handleJumpToVideo = (time, src = null) => {
            const targetSrc = src || videoUrl;
            if (time === null || time === undefined) return;
            if (!targetSrc) return alert("è¯·å…ˆåœ¨ç›‘æ§é¡µä¸Šä¼ è§†é¢‘ï¼");
            // å¼¹çª—æ—¶ä½¿ç”¨æŒ‡å®šçš„ src
            setPlayModal({ show: true, startTime: time, src: targetSrc });
            setPushNotification(null);
          };

          // --- AI é—®ç­”é€»è¾‘ ---
          const callGeminiAI = async (userQuery, currentLogs) => {
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½å® ç‰©ç›‘æ§åŠ©æ‰‹ PetGuardã€‚
            ã€å®¶åº­æ¡£æ¡ˆã€‘${JSON.stringify(PET_DATA)}
            ã€ä»Šæ—¥æ—¥å¿—ã€‘${currentLogs.map(l => `${l.time} ${l.action}`).join(', ')}
            è¯·ç®€ç»ƒå›ç­”ï¼Œè¯­æ°”äº²åˆ‡ã€‚`;

            // æœ¬åœ°å…œåº•å›å¤é€»è¾‘ (å½“æ²¡æœ‰ Key æ—¶ä½¿ç”¨)
            const getFallbackResponse = () => {
               const q = userQuery.toLowerCase();
               if (q.includes("è¡¨ç°") || q.includes("æ€»ç»“")) return `ä»Šæ—¥æ€»ç»“ï¼š\n1. **æ —å­**ï¼šç²¾åŠ›æ—ºç››ï¼Œæœ‰ä¸€æ¬¡è·³æ¡Œå­è¿è§„ã€‚\n2. **å¥¶æ²¹**ï¼šå²æœˆé™å¥½ï¼Œå¤§éƒ¨åˆ†æ—¶é—´åœ¨ä¼‘æ¯ã€‚`;
               if (q.includes("æ —å­")) return `**æ —å­**ä»Šå¤©éå¸¸æ´»è·ƒï¼Œæ—©ä¸Šè·‘é…·ï¼Œæ™šä¸Šè¿˜è·³äº†ä¸€æ¬¡æ¡Œå­ã€‚`;
               if (q.includes("å¥¶æ²¹")) return `**å¥¶æ²¹**ä»Šå¤©å¾ˆè®©äººçœå¿ƒï¼Œæ´»è·ƒåº¦ä¸é«˜ï¼Œä¸€ç›´åœ¨æš—ä¸­è§‚å¯Ÿã€‚`;
               if (q.includes("å¼‚å¸¸") || q.includes("è¿è§„") || q.includes("è·‘é…·")) return `æ£€æµ‹åˆ°é«˜èƒ½æ—¶åˆ»ï¼š**23:09** æ —å­å’Œå¥¶æ²¹åœ¨å®¢å…è¿›è¡Œäº†æ¿€çƒˆçš„**æ·±å¤œè·‘é…·**ï¼ˆå·²ä¸ºæ‚¨ç”Ÿæˆæ™ºèƒ½å¡ç‰‡ï¼‰ã€‚`;
               return "æˆ‘æ˜¯ PetGuard æ™ºèƒ½åŠ©æ‰‹ã€‚æ‚¨å¯ä»¥é—®æˆ‘â€œæ —å­ä»Šå¤©å¹²äº†ä»€ä¹ˆï¼Ÿâ€æˆ–è€…â€œè°åœ¨è·‘é…·ï¼Ÿâ€";
            };

            if (!CONFIG.apiKey) { await new Promise(r => setTimeout(r, 800)); return getFallbackResponse(); }

            try {
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${CONFIG.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
              });
              if (!response.ok) return getFallbackResponse();
              const data = await response.json();
              return data.candidates?.[0]?.content?.parts?.[0]?.text || getFallbackResponse();
            } catch (error) { return getFallbackResponse(); }
          };

          const handleSendMessage = async (text = inputMessage) => {
            if (!text.trim()) return;
            const newUserMsg = { id: Date.now(), type: 'user', text: text, time: 'åˆšåˆš' };
            setChatMessages(prev => [...prev, newUserMsg]);
            setInputMessage('');
            setIsAiThinking(true);
            const aiResponseText = await callGeminiAI(text, logs);
            setIsAiThinking(false);
            setChatMessages(prev => [...prev, { id: Date.now() + 1, type: 'bot', text: aiResponseText, time: 'åˆšåˆš' }]);
          };

          // --- ç»„ä»¶æ¸²æŸ“ ---
          const TabButton = ({ id, icon: Icon, label }) => (
            <button onClick={() => setActiveTab(id)} className={`flex flex-col items-center justify-center w-full py-2 transition-colors ${activeTab === id ? 'text-orange-600' : 'text-gray-400'}`}>
              <Icon size={24} className={`mb-1 ${activeTab === id ? 'scale-110' : ''} transition-transform`} />
              <span className="text-[10px] font-medium">{label}</span>
            </button>
          );

          return (
            <div className="bg-gray-50 min-h-screen font-sans text-gray-900 pb-20 relative max-w-md mx-auto shadow-2xl overflow-hidden border-x border-gray-200 flex flex-col">
              
              {/* ğŸ”” é¡¶éƒ¨ Push é€šçŸ¥æ¡ */}
              {pushNotification && (
                <div onClick={() => handleJumpToVideo(pushNotification.videoTime)} className="fixed top-4 left-4 right-4 bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl z-[60] border-l-4 border-orange-500 p-4 animate-in slide-in-from-top-4 duration-500 cursor-pointer flex items-start gap-3 ring-1 ring-black/5">
                   <div className="bg-orange-100 p-2 rounded-full text-orange-600 flex-shrink-0 mt-0.5"><AlertTriangle size={20} /></div>
                   <div className="flex-1 min-w-0"><div className="flex justify-between items-start"><h4 className="font-bold text-gray-900 text-sm">PetGuard æ™ºèƒ½è­¦æŠ¥</h4><span className="text-[10px] text-gray-400">åˆšåˆš</span></div><p className="font-medium text-gray-800 text-xs mt-1 truncate">{pushNotification.title}</p><p className="text-gray-500 text-[10px] mt-0.5 line-clamp-2">{pushNotification.text}</p></div>
                </div>
              )}
              
              {/* ğŸ¬ å›æ”¾å¼¹çª— (æ— æ¡†çº¯å‡€ç‰ˆ) */}
              {playModal.show && (
                <div className="fixed inset-0 z-50 bg-black/95 flex flex-col justify-center items-center animate-in fade-in duration-200">
                  <button onClick={() => setPlayModal({ show: false, startTime: 0, src: null })} className="absolute top-4 right-4 text-white p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-50"><X size={24} /></button>
                  <div className="w-full aspect-video bg-black relative">
                    <video ref={modalVideoRef} src={playModal.src || videoUrl} className="w-full h-full object-contain" controls muted={isMuted} />
                  </div>
                  <div className="mt-6 text-white/90 text-sm bg-gray-800/80 px-6 py-2 rounded-full border border-white/10 flex
